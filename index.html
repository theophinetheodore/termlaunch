<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="output.css">
    <link rel="stylesheet" href="style.css">
    <title>termlaunch</title>

<style>
@font-face {
font-display: swap;
font-family: 'Cascadia';
font-style: normal;
font-weight: 400;
src: url('/cascadia.woff2') format('woff2');
}
body {
padding: 0.5rem;
padding-top: 2rem;
font-family: monospace;
font-size: 17px;
}
* {
color: white;
font-family: "Cascadia", monospace;
user-select: none;
}
pre {
font-size: 15px;
}
input {
font-size: 17px;
border: none;
outline: none;
background: transparent;
margin-top: 0.5rem;
width: calc(100dvw - 80px);
}
#app-name {
text-decoration: underline;
}
#apps {
height: 40dvh;
border: 2px solid #393939;
border-radius: 0.5rem;
padding: 1rem;
overflow: auto;
}
</style>
</head>

<body>
</body>

<script>
document.addEventListener('DOMContentLoaded', async () => {
	document.body.innerHTML += motd();
	addInputField();

	const apps = await loadApps();

	function addInputField() {
	const terminal = document.querySelector('body');
	const commandDiv = document.createElement('div');
	commandDiv.className = 'command';

	const prompt = document.createElement('span');
	prompt.textContent = ">>> ";
	commandDiv.appendChild(prompt);

	const input = document.createElement('input');
	input.type = 'text';
	commandDiv.appendChild(input);

	terminal.appendChild(commandDiv);
	input.focus();

	input.addEventListener('keydown', (event) => {
	    if (event.key === 'Enter') {
	        const command = input.value;
	        executeCommand(command, commandDiv);

	        input.setAttribute('readonly', true);
		input.removeEventListener('keydown', this); 
	        input = null;
	    }
	});
}
	
    function executeCommand(command, commandDiv) {
        let response;

	if (command == "help") {
                response = `
		- help: print this help text.<br>
		- clear: clears the console.<br>
		- date: prints date.<br>
		- apps: prints list of apps.<br>
		- x/open [query]: opens app.<br>
		- remove [app.packageName]: removes app.<br>
		- info [app.packageName]: opens app info.<br>
		- toggle: toggles bridge button.<br>
		- console: opens developer console.<br>
		- settings: opens bridge settings.<br>
		`;
	} else if (command == "date") {
		response = new Date().toLocaleString('en-GB', {
			weekday: "long", year: "numeric", month: "long", day: "numeric", hour: '2-digit', minute: '2-digit', second: '2-digit'
		});
	} else if (command == "clear") {
                document.body.innerHTML = '';
		document.body.innerHTML += motd();
	} else if (command == "apps") {
		response = listApps(apps);
	} else if (command == "toggle") {
		if (Bridge.getBridgeButtonVisibility() != "shown") {
			Bridge.requestSetBridgeButtonVisibility("shown");
			response = "bridge button shown.";
		} else {
			Bridge.requestSetBridgeButtonVisibility("hidden");
			response = "bridge button hidden.";
		}
	} else if (command.startsWith("console")) {
		Bridge.requestOpenDeveloperConsole();
		response = "developer console opened.";
	} else if (command.startsWith("settings")) {
		Bridge.requestOpenBridgeSettings();
		response = "bridge settings opened.";
	} else if (command.startsWith("x") || command.startsWith("open")) {
		const blocks = command.split(" ");
		response = open(apps, blocks[1]);
	} else if (command.startsWith("remove")) {
		const blocks = command.split(" ");
		response = remove(apps, blocks[1]);
	} else if (command.startsWith("info")) {
		const blocks = command.split(" ");
		response = info(apps, blocks[1]);
	} else {
		response = "command not found: " + command;
	}

        const outputDiv = document.createElement('div');
        outputDiv.className = 'output';
        outputDiv.innerHTML = `${response}`;
        commandDiv.appendChild(outputDiv);

        addInputField();
    }
});

function open(apps, text) {
	if (text.length <= 2) {
		return "text is too short."
	}

	let packageName = "";
	apps.forEach(item => {
		if (item.packageName.includes(text) || item.label.toLowerCase().includes(text)) {
			packageName = item.packageName;
			Bridge.requestLaunchApp(item.packageName);
		}
	});

	if (packageName.length != 0) {
		return `opening ${packageName}...`;
	} else {
		return `app not found.`;
	}
}

function remove(apps, packagename) {
	Bridge.requestAppUninstall(packagename);
	return "";
}

function info(apps, packagename) {
	Bridge.requestOpenAppInfo(packagename);
	return "";
}

function listApps(apps) {
text = "<div id='apps'";
for (const app of apps) {
	text += `<span id="app-name"
		onclick='Bridge.requestLaunchApp("${app.packageName}");'>
			${app.packageName}
		</span><br>`;
}
text += "</div>"
return text;
}

async function loadApps() {
const resp = await fetch(Bridge.getAppsURL());
const json = await resp.json();

return json.apps;
}

function motd() {
return `
<pre>
  __                __                   __ 
 / /____ ______ _  / /__  __ _____  ____/ / 
/ __/ -_) __/  ' \\/ / _ \\/ // / _ \\/ __/ _ \\ 
\\__/\\__/_/ /_/_/_/_/\\_,_/\\_,_/_//_/\\__/_//_/
</pre>

<div>termlaunch 0.1.0</div>
<div>OS: Android 10. (API ${Bridge.getAndroidAPILevel()})</div>
<div>Powered by Bridge Launcher ${Bridge.getBridgeVersionName()}.</div>
<div>Made by Savio.</div>
<div>type "help" for more information.</div>`;
}
</script>
</html>
